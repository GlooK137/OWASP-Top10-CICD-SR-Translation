# CICD-SEC-8: Неуправляемое использование сторонних сервисов
## Определение
Атакующая поверхность CI/CD состоит из органических активов организации, таких как SCM или CI, и сторонних сервисов, которым предоставляется доступ к этим органическим активам. Риски, связанные с неуправляемым использованием сторонних сервисов, основаны на чрезвычайной простоте предоставления сторонним сервисам доступа к ресурсам в системах CI/CD, что эффективно расширяет поверхность атаки организации.

## Описание
Редко можно встретить организацию, в которой к системам и процессам CI/CD не подключены многочисленные сторонние сервисы. Простота их внедрения в сочетании с непосредственной ценностью сделали сторонние организации неотъемлемой частью повседневной инженерной деятельности. Методы встраивания или предоставления доступа к сторонним системам становятся все более разнообразными, а сложности, связанные с их внедрением, уменьшаются.

На примере распространенной SCM - GitHub SAAS - подключение сторонних приложений может осуществляться одним или несколькими из этих 5 методов:

- Приложение GitHub
- Приложение OAuth
- Предоставление токена доступа стороннему приложению
- Предоставление SSH-ключа стороннему приложению.
- Настройка событий webhook для отправки стороннему приложению.

Реализация каждого из этих методов занимает от нескольких секунд до нескольких минут и предоставляет сторонним пользователям множество возможностей, начиная от чтения кода в одном репозитории и заканчивая полным администрированием организации GitHub. Несмотря на потенциально высокий уровень разрешений, предоставляемых третьим лицам в рамках системы, во многих случаях никаких специальных разрешений или согласований с организацией до фактического внедрения не требуется.

Системы сборки также позволяют легко интегрировать сторонние разработчики. Интеграция сторонних компонентов в конвейеры сборки обычно не сложнее добавления 1-2 строк кода в конфигурационный файл конвейера или установки плагина из рыночной среды системы сборки (например, actions в Github Actions, Orbs в CircleCI). Затем сторонняя функциональность импортируется и выполняется как часть процесса сборки с полным доступом ко всем ресурсам, доступным на этапе конвейера, на котором она выполняется.

Подобные методы подключения доступны в различных формах в большинстве систем CI/CD, что делает процесс управления и поддержки наименьших привилегий при использовании сторонних функций во всей инженерной экосистеме чрезвычайно сложным. Организации сталкиваются с проблемой получения полной информации о том, какие сторонние организации имеют доступ к различным системам, какими методами они пользуются, какой уровень разрешений/доступа им был предоставлен и какой уровень разрешений/доступа они фактически используют.

## Влияние
Отсутствие управления и контроля за внедрением сторонних систем не позволяет организациям поддерживать RBAC в своих системах CI/CD. Учитывая, что сторонние организации, как правило, имеют достаточно широкие полномочия, безопасность организаций зависит только от того, какие сторонние организации они внедряют. Недостаточная реализация RBAC и наименьших привилегий для сторонних организаций, а также минимальное управление и тщательность в процессе внедрения сторонних организаций значительно увеличивают поверхность атаки организации.

Учитывая высокую степень взаимосвязанности систем и сред CI/CD, компрометация одной третьей стороны может быть использована для нанесения ущерба, выходящего далеко за рамки системы, к которой она подключена (например, третья сторона, имеющая права на запись в репозиторий, может быть использована злоумышленниками для отправки кода в репозиторий, что, в свою очередь, приведет к запуску сборки и выполнению вредоносного кода на системе сборки).

## Рекомендации
Контроль управления сервисами сторонних организаций должен быть реализован на каждом этапе жизненного цикла использования сторонних услуг:

- [ ] **Утверждение** - Установить процедуры проверки для обеспечения того, чтобы сторонние организации, получающие доступ к ресурсам в любой точке инженерной экосистемы, утверждались до предоставления доступа к среде, а уровень предоставляемых им разрешений соответствовал принципу наименьших привилегий.
- [ ] **Интеграция** - Внедрение средств контроля и процедур для обеспечения непрерывной видимости всех сторонних организаций, интегрированных в системы CI/CD, включая:
	- [ ] Метод интеграции. Убедитесь, что охвачены все методы интеграции для каждой системы (включая приложения Marketplace, плагины, приложения OAuth, программные маркеры доступа и т.д.).
	- [ ] Уровень разрешения, предоставленного третьей стороне.
	- [ ] Уровень разрешения, фактически используемого третьей стороной.
- [ ] **Видимость текущего использования** - убедитесь, что доступ каждой третьей стороны к определенным ресурсам ограничен, и удалите неиспользуемые и/или избыточные разрешения. Сторонние программы, интегрированные в процесс сборки, должны работать в рамках ограниченного контекста с ограниченным доступом к секретам и коду, а также со строгими фильтрами входа и выхода.
- [ ] Депровизирование - периодически проверяйте все интегрированные сторонние программы и удаляйте те из них, которые больше не используются.
## Ссылки
1. Codecov, популярный инструмент покрытия кода, используемый в CI, скомпрометирован для кражи переменных окружения из сборок.
https://about.codecov.io/security-update/

2. Злоумышленники скомпрометировали учетную запись GitHub инженера DeepSource (платформа статического анализа). Используя скомпрометированную учетную запись, они получают права доступа к GitHub-приложению DeepSource, что дает им полный доступ к кодовой базе всех клиентов DeepSource, установивших скомпрометированное GitHub-приложение.
https://discuss.deepsource.io/t/security-incident-on-deepsource-s-github-application/131

3. Злоумышленники получили доступ к базе данных Waydev, аналитической платформы git, и похитили OAuth-токены GitHub и GitLab своих клиентов.
https://changelog.waydev.co/github-and-gitlab-oauth-security-update-dw98s