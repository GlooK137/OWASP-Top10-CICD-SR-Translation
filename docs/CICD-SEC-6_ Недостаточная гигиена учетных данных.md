# CICD-SEC-6: Недостаточная гигиена учетных данных
## Определение
Риски недостаточной гигиены учетных данных связаны с возможностью злоумышленника получить и использовать различные секреты и токены, распределенные по конвейеру, из-за недостатков, связанных с контролем доступа к учетным данным, небезопасным управлением секретами и чрезмерно разрешенными учетными данными.

## Описание
CI/CD-среды состоят из множества систем, взаимодействующих и аутентифицирующихся друг с другом, что создает большие проблемы с защитой учетных данных из-за большого разнообразия контекстов, в которых они могут существовать.

Учетные данные приложения используются приложением во время выполнения, учетные данные производственных систем используются конвейерами для развертывания инфраструктуры, артефактов и приложений на производстве, инженеры используют учетные данные в своих тестовых средах, в коде и артефактах.

Такое разнообразие контекстов в сочетании с большим количеством методов и способов их хранения и использования создает большой потенциал для небезопасного использования учетных данных. Некоторые основные недостатки, влияющие на гигиену использования учетных данных:

- Попадание кода, содержащего учетные данные, в одну из веток SCM-репозитория: Это может произойти как по ошибке - не заметив наличия секрета в коде, так и преднамеренно - не понимая, чем это чревато. С этого момента учетные данные становятся доступны всем, кто имеет доступ к репозиторию на чтение, и даже если они удалены из ветки, в которую были помещены, то продолжают отображаться в истории коммитов, доступной всем, кто имеет доступ к репозиторию.
- Учетные данные, небезопасно используемые в процессах сборки и развертывания: Эти учетные данные используются для доступа к репозиториям кода, чтения из репозиториев артефактов и записи в них, а также для развертывания ресурсов и артефактов в производственных средах. Учитывая большое количество конвейеров и целевых систем, к которым им необходим доступ, крайне важно понимать, в каком контексте и с помощью какого метода они используются.
	- В каком контексте и с помощью какого метода используется каждый набор учетных данных?
	- Может ли каждый конвейер получить доступ только к тем учетным данным, которые необходимы ему для выполнения своей задачи?
	- Может ли доступ к учетным данным получить не просматриваемый код, проходящий через конвейер?
	- Как эти учетные данные вызываются и внедряются в сборку? Доступны ли эти учетные данные только во время выполнения и только из тех контекстов, где они требуются?
- Учетные данные в слоях образа контейнера: Учетные данные, которые требовались только для сборки образа, по-прежнему находятся в одном из слоев образа - они доступны любому, кто сможет загрузить образ.
- Учетные данные, выводимые на консольный вывод: Учетные данные, используемые в конвейерах, часто выводятся на консольный вывод, преднамеренно или непреднамеренно. В результате этого учетные данные могут оказаться в открытом виде в журналах, доступных для просмотра любому, кто имеет доступ к результатам сборки. Такие журналы могут попасть в системы управления журналами, что увеличивает их уязвимость.
- Неразвернутые учетные данные: Поскольку учетные данные разбросаны по всей инженерной экосистеме, они становятся доступными для большого числа сотрудников и подрядчиков. Отсутствие ротации учетных данных приводит к тому, что количество людей и артефактов, обладающих действительными учетными данными, постоянно растет. Это особенно актуально для учетных данных, используемых в конвейерных системах, например ключей развертывания, которые часто управляются по принципу "если не сломалось, не чини", в результате чего действительные учетные данные не ротируются в течение многих лет.

## Влияние
Учетные данные являются наиболее востребованным объектом для злоумышленников, которые стремятся использовать их для доступа к ценным ресурсам или для развертывания вредоносного кода и артефактов. В этом контексте инженерные среды предоставляют злоумышленникам множество возможностей для получения учетных данных. Большой потенциал человеческого фактора, а также пробелы в знаниях о безопасном управлении учетными данными и опасения нарушения процессов из-за ротации учетных данных подвергают риску компрометации высокоценные ресурсы многих организаций в результате раскрытия их учетных данных.

## Рекомендации
- [ ] Разработать процедуры постоянного сопоставления учетных данных, найденных в различных системах инженерной экосистемы - от кода до развертывания. Убедитесь, что каждый набор учетных данных соответствует принципу наименьших привилегий и имеет именно тот набор разрешений, который необходим использующему его сервису.
- [ ] Избегайте совместного использования одного и того же набора учетных данных в нескольких контекстах. Это усложняет реализацию принципа наименьших привилегий, а также негативно сказывается на подотчетности.
- [ ] Предпочтительнее использовать временные учетные данные, чем статические. В случае необходимости использования статических учетных данных следует установить процедуру периодической ротации всех статических учетных данных и выявления устаревших учетных данных.
- [ ] Настройте использование учетных данных так, чтобы оно было ограничено заранее определенными условиями (например, привязкой к конкретному IP-адресу источника или идентификатору), чтобы даже в случае компрометации утечка учетных данных не могла быть использована за пределами вашей среды.
- [ ] Обнаружение секретов, передаваемых и хранящихся в репозиториях кода. Используйте такие средства контроля, как плагин IDE для выявления секретов, используемых в локальных изменениях, автоматическое сканирование при каждом обновлении кода, а также периодическое сканирование репозитория и его прошлых коммитов.
- [ ] Убедитесь, что секреты, используемые в системах CI/CD, распределены таким образом, что каждый конвейер и этап имеет доступ только к тем секретам, которые ему необходимы.
- [ ] Используйте встроенные опции производителя или инструменты сторонних производителей для предотвращения печати секретов в консольных выводах будущих сборок. Убедитесь, что все существующие выходные данные не содержат секретов.
- [ ] Убедитесь, что секреты удалены из артефактов любого типа, например, из слоев образов контейнеров, двоичных файлов или диаграмм Helm.
## Ссылки
1. Тысячи учетных данных, хранящихся в виде переменных окружения, были похищены злоумышленниками в результате компрометации Codecov, популярного инструмента покрытия кода, используемого в CI.
https://about.codecov.io/security-update/

2. Travis CI внедрял защищенные переменные окружения публичных репозиториев в сборки, создаваемые с помощью pull request, что делало их уязвимыми для компрометации анонимными пользователями, отправляющими pull request на публичные репозитории.
https://travis-ci.community/t/security-bulletin/12081

3. Злоумышленник скомпрометировал сервер TeamCity Build компании Stack Overflow и смог похитить секреты из-за небезопасного способа их хранения.
https://stackoverflow.blog/2021/01/25/a-deeper-dive-into-our-may-2019-security-incident/

4. Компания Samsung раскрыла слишком разрешительные секреты в публичных репозиториях GitLab.
https://techcrunch.com/2019/05/08/samsung-source-code-leak/

5. Злоумышленники получили доступ к закрытым репозиториям GitHub компании Uber, содержащим разрешительные и общие токены AWS, что привело к утечке данных миллионов водителей и пассажиров. https://www.ftc.gov/system/files/documents/federal_register_notices/2018/04/152_3054_uber_revised_consent_analysis_pub_frn.pdf

6. Получение доступа на запись к Homebrew, автор Эрик Холмс. Экземпляр Homebrew Jenkins раскрывал переменные окружения выполняемых сборок, в том числе токен GitHub, что позволяло злоумышленнику вносить вредоносные изменения в сам проект Homebrew.
https://medium.com/@vesirin/how-i-gained-commit-access-to-homebrew-in-30-minutes-2ae314df03ab