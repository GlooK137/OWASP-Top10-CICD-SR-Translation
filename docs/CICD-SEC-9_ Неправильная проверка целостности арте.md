# CICD-SEC-9: Неправильная проверка целостности артефактов
## Определение
Неправильная проверка целостности артефактов может привести к тому, что злоумышленник, получивший доступ к одной из систем CI/CD-процесса, сможет продвигать по конвейеру вредоносный (хотя на первый взгляд и доброкачественный) код или артефакты, поскольку механизмы проверки кода и артефактов недостаточно эффективны.

## Описание
Процессы CI/CD состоят из множества этапов, которые в конечном итоге отвечают за прохождение кода от рабочего места инженера до производства. На каждом этапе используется множество ресурсов, сочетающих внутренние ресурсы и артефакты с пакетами и артефактами сторонних разработчиков, получаемыми из удаленных мест. Тот факт, что конечный ресурс зависит от множества источников, распределенных по разным этапам и предоставленных множеством участников, создает множество точек входа, через которые этот конечный ресурс может быть подделан.

Если фальсифицированный ресурс смог успешно проникнуть в процесс доставки, не вызвав никаких подозрений и не встретив никаких ворот безопасности, то он, скорее всего, продолжит движение по конвейеру - вплоть до производства - под видом легитимного ресурса.

## Влияние
Неправильная проверка целостности артефакта может быть использована противником, закрепившимся в процессе поставки ПО, для отправки вредоносного артефакта по конвейеру, что в конечном итоге приведет к выполнению вредоносного кода - либо на системах в рамках процесса CI/CD, либо, что еще хуже, в производстве.

## Рекомендации
Для предотвращения рисков ненадлежащей проверки целостности артефактов необходим комплекс мер, охватывающий различные системы и этапы цепочки поставки программного обеспечения. Рассмотрим следующие меры контроля:
- [ ] Внедрить процессы и технологии для проверки целостности ресурсов на всех этапах разработки и производства. При создании ресурса процесс включает его подписание с использованием внешней инфраструктуры подписания ресурсов. Перед использованием ресурса на последующих этапах конвейера его целостность должна быть проверена с помощью подписывающего органа. Некоторые распространенные меры, которые следует рассмотреть в этом контексте:
- [ ] Подписание кода - SCM-решения предоставляют возможность подписывать коммиты, используя уникальный ключ для каждого участника. Эта мера может быть использована для предотвращения попадания неподписанных коммитов в конвейер.
- [ ] Программное обеспечение для верификации артефактов - использование инструментов для подписи и верификации кода и артефактов позволяет предотвратить попадание непроверенного программного обеспечения на конвейер. Примерами таких проектов являются in-toto, SLSA и Sigstore, входящие в состав Linux Foundation.
- [ ] Обнаружение дрейфа конфигурации - меры, направленные на обнаружение дрейфа конфигурации (например, ресурсов в облачных средах, которые не управляются с помощью подписанного шаблона IAC), что может свидетельствовать о ресурсах, развернутых недоверенным источником или процессом.
- [ ] Ресурсы сторонних производителей, получаемые из конвейеров сборки/развертывания (например, скрипты, импортируемые и выполняемые в процессе сборки), должны следовать аналогичной логике - перед использованием ресурсов сторонних производителей хэш ресурса должен быть вычислен и сверен с официальным опубликованным хэшем поставщика ресурса.
## Ссылки
1. Взлом системы сборки SolarWinds, использовавшийся для распространения вредоносного ПО через SolarWinds в 18 тыс. организаций. Код программного обеспечения Orion был изменен в системе сборки в процессе сборки, не оставив никаких следов в кодовой базе.
https://sec.report/Document/0001628280-20-017451/#swi-20201214.htm

2. Codecov, популярный инструмент покрытия кода, используемый в CI, скомпрометирован для кражи переменных окружения из сборок. Злоумышленники получили доступ к учетной записи GCP (Google Cloud Platform), на которой размещен скрипт Codecov, и модифицировали его, добавив вредоносный код. Атака была обнаружена заказчиком, сравнившим хэш скрипта, хранящегося на GitHub, со скриптом, загруженным из учетной записи GCP.
https://about.codecov.io/security-update/

3. Бэкдор, внедренный в git-репозиторий PHP, в итоге привел к распространению формальной версии PHP среди всех пользователей PHP. Злоумышленники размещают вредоносный непроверенный код непосредственно в основной ветке PHP, фиксируя его так, как будто он был создан известными разработчиками PHP.
https://news-web.php.net/php.internals/113981

4. Злоумышленники скомпрометировали сервер сборки Webmin и добавили бэкдор в один из скриптов приложения. Бэкдор продолжал существовать даже после того, как скомпрометированный сервер сборки был выведен из эксплуатации, поскольку код был восстановлен из локальной резервной копии, а не из системы контроля исходных текстов. Пользователи Webmin были подвержены RCE-атаке по цепочке поставок в течение более 15 месяцев, пока бэкдор не был удален.
https://www.webmin.com/exploit.html