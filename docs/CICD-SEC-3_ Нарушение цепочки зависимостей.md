# CICD-SEC-3: Нарушение цепочки зависимостей
## Определение
Риски злоупотребления цепочками зависимостей связаны с возможностью злоумышленника использовать недостатки, связанные с получением зависимостей кода на рабочих станциях инженеров и в средах сборки. В результате злоупотребления цепочкой зависимостей вредоносный пакет может быть случайно извлечен и выполнен локально при извлечении.

## Описание
Управление зависимостями и внешними пакетами, используемыми в самописном коде, становится все более сложным, учитывая общее количество систем, вовлеченных в этот процесс во всех контекстах разработки в организации. Часто пакеты извлекаются с помощью специального клиента для каждого языка программирования, обычно из комбинации самоуправляемых репозиториев пакетов (например, Jfrog Artifactory) и SaaS-репозиториев для конкретного языка (например, в Node.js есть npm и реестр npm, в Python - pip, в PyPI - PyPI, а в Ruby - RubyGems).

Многие организации прилагают все усилия для выявления использования пакетов с известными уязвимостями и проводят статический анализ как собственного, так и стороннего кода. Однако в контексте использования зависимостей существует не менее важный набор средств контроля, необходимых для обеспечения безопасности экосистемы зависимостей, - это защита процесса, определяющего, каким образом происходит извлечение зависимостей. Неадекватные конфигурации могут привести к тому, что ничего не подозревающий инженер, или, что еще хуже, система сборки, загрузит вредоносный пакет вместо того пакета, который был предназначен для извлечения. Во многих случаях пакет не только загружается, но и сразу же исполняется после загрузки, благодаря скриптам предустановки и другим подобным процессам, которые предназначены для выполнения кода пакета сразу же после его извлечения.

Основными векторами атак в данном контексте являются:

- Перепутывание зависимостей - публикация вредоносных пакетов в публичных репозиториях с теми же именами, что и имена внутренних пакетов, с целью склонить клиента к загрузке вредоносного, а не приватного пакета.
- Перехват зависимостей - получение контроля над учетной записью сопровождающего пакета в публичном репозитории с целью загрузки новой вредоносной версии широко используемого пакета, чтобы скомпрометировать ничего не подозревающих клиентов, которые получат последнюю версию пакета.
- Типосквоттинг - публикация вредоносных пакетов с именами, похожими на имена популярных пакетов, в надежде на то, что разработчик неправильно произнесет имя пакета и непреднамеренно получит пакет с типосквоттингом.
- Brandjacking - публикация вредоносных пакетов в манере, совпадающей с наименованием или другими характеристиками пакетов определенного бренда, с целью заставить ничего не подозревающих разработчиков получить эти пакеты, ошибочно ассоциируя их с надежным брендом.

## Воздействие
Целью злоумышленников, загружающих пакеты в публичные репозитории пакетов с помощью одной из описанных выше технологий, является выполнение вредоносного кода на хосте, извлекающем пакет. Это может быть как рабочая станция разработчика, так и сервер сборки, на который загружается пакет.

После запуска вредоносного кода он может быть использован для кражи учетных данных и латерального перемещения в среде, в которой он был запущен.

Другим возможным сценарием является попадание вредоносного кода с сервера сборки в производственную среду. Во многих случаях вредоносный пакет будет продолжать поддерживать исходную, безопасную функциональность, на которую рассчитывал пользователь, что снижает вероятность его обнаружения.

## Рекомендации
Существует широкий спектр методов защиты, которые зависят от конфигурации различных языковых клиентов, а также от того, как используются внутренние прокси и внешние репозитории пакетов.

При этом все рекомендуемые средства контроля имеют общие руководящие принципы.

- [ ] Любой клиент, извлекающий пакеты кода, не должен получать пакеты непосредственно из Интернета или недоверенных источников. Вместо этого должны быть реализованы следующие средства контроля:
	- [ ] При получении пакетов сторонних разработчиков из внешнего репозитория убедиться, что все пакеты получены через внутренний прокси-сервер, а не напрямую из Интернета. Это позволяет развернуть дополнительные средства контроля безопасности на уровне прокси-сервера, а также обеспечить возможность расследования в случае инцидента безопасности.
	- [ ] Там, где это возможно, запретите получение пакетов непосредственно из внешних репозиториев. Настройте всех клиентов на получение пакетов из внутренних репозиториев, содержащих предварительно проверенные пакеты, и создайте механизм проверки и обеспечения соблюдения этой конфигурации клиента.
- [ ] Включите проверку контрольной суммы и подписи для извлеченных пакетов.
- [ ] Избегайте настройки клиентов на извлечение последней версии пакета. Предпочтительнее настраивать предварительно проверенные версии или диапазоны версий. Используйте специфические для фреймворка методы для постоянной "блокировки" версий пакетов, необходимых в вашей организации, до стабильной и безопасной версии.
- [ ] Области применения:
	- [ ] Убедитесь, что все частные пакеты зарегистрированы в области действия организации.
	- [ ] Убедитесь, что весь код, ссылающийся на частный пакет, использует область видимости этого пакета.
	- [ ] Убедитесь, что клиенты вынуждены получать пакеты, находящиеся в области действия организации, только из внутреннего реестра.
- [ ] Если в процессе установки пакета выполняются сценарии установки, убедитесь, что для этих сценариев существует отдельный контекст, не имеющий доступа к секретам и другим конфиденциальным ресурсам, доступным на других этапах процесса сборки.
- [ ] Убедитесь, что внутренние проекты всегда содержат конфигурационные файлы менеджеров пакетов (например, .npmrc в NPM) в репозитории кода проекта, чтобы отменить любую небезопасную конфигурацию, потенциально существующую на клиенте, получающем пакет.
- [ ] Избегайте публикации имен внутренних проектов в публичных репозиториях.
- [ ] Как правило, учитывая количество одновременно используемых пакетных менеджеров и конфигураций, полное предотвращение злоупотребления цепочками сторонних разработчиков далеко не всегда является тривиальной задачей. Поэтому рекомендуется уделять должное внимание обнаружению, мониторингу и устранению последствий, чтобы в случае инцидента он был выявлен как можно быстрее и нанес минимальный потенциальный ущерб. В связи с этим все соответствующие системы должны быть должным образом защищены в соответствии с рекомендациями по риску "CICD-SEC-7: небезопасная конфигурация системы".

## Ссылки
1. Запутывание зависимостей, автор Алекс Бирсан. Вектор атаки, в результате которой менеджеры пакетов и прокси-серверы обманываются и получают вредоносный пакет из публичного репозитория вместо предполагаемого одноименного пакета из внутреннего репозитория.
https://medium.com/@alex.birsan/dependency-confusion-4a5d60fec610

2. NodeJS-приложения Amazon, Zillow, Lyft и Slack, подвергшиеся атакам злоумышленников, использующих уязвимость Dependency Confusion.
https://www.bleepingcomputer.com/news/security/malicious-npm-packages-target-amazon-slack-with-new-dependency-attacks/

3. NPM-библиотека ua-parser-js, имеющая 9 млн. загрузок в неделю, была взломана для запуска криптомайнеров и кражи учетных данных.
https://github.com/advisories/GHSA-pjwm-rvh2-c87w

4. NPM-библиотека coa, имеющая 9 млн. загрузок в неделю, была взломана с целью кражи учетных данных.
https://github.com/advisories/GHSA-73qr-pfmq-6rp8

5. NPM-библиотека rc с 14 млн. загрузок в неделю была взломана с целью кражи учетных данных.
https://github.com/advisories/GHSA-g2q5-5433-rhrf