# CICD-SEC-5: Недостаточный контроль доступа PBAC (Pipeline-Based Access Controls)
## Определение
Узлы выполнения конвейера имеют доступ к многочисленным ресурсам и системам внутри и вне среды выполнения. При выполнении вредоносного кода внутри конвейера злоумышленники используют недостаточные риски PBAC (Pipeline-Based Access Controls) для злоупотребления предоставленными конвейеру правами на перемещение внутри или вне системы CI/CD.

## Описание
Конвейеры - это "бьющееся сердце" CI/CD. Узлы, выполняющие конвейеры, выполняют команды, указанные в конфигурации конвейера, и тем самым осуществляют широкий спектр конфиденциальных действий:

- Доступ к исходному коду, его сборка и тестирование.
- Получение секретов из различных мест, таких как переменные окружения, хранилища, специальные облачные сервисы идентификации (например, сервис метаданных AWS) и другие места.
- Создавать, изменять и развертывать артефакты.
PBAC - это термин, обозначающий контекст, в котором выполняется каждый конвейер - и каждый шаг в рамках этого конвейера. Учитывая очень чувствительный и критический характер каждого конвейера, крайне важно ограничить каждый конвейер именно тем набором данных и ресурсов, к которым ему необходим доступ. В идеале каждый конвейер и шаг должны быть ограничены таким образом, чтобы в случае, если противнику удастся выполнить вредоносный код в контексте конвейера, размер потенциального ущерба был минимальным.

PBAC включает в себя средства контроля, относящиеся к многочисленным элементам, имеющим отношение к среде выполнения конвейера:

- Доступ в среде выполнения конвейера: к коду, секретам, переменным окружения и другим конвейерам.
- Разрешения на базовый хост и другие узлы конвейера.
- Фильтры входа и выхода в Интернет.
## Воздействие
Фрагмент вредоносного кода, способный работать в контексте узла выполнения конвейера, обладает всеми разрешениями того этапа конвейера, на котором он работает. Он может получить доступ к секретам, к базовому узлу и подключиться к любой системе, к которой имеет доступ данный конвейер. Это может привести к раскрытию конфиденциальных данных, латеральному перемещению внутри среды CI - потенциальному доступу к серверам и системам за пределами среды CI, а также к развертыванию вредоносных артефактов по конвейеру, в том числе и в производство.

Степень потенциального ущерба от сценария, в котором противнику удается скомпрометировать узлы выполнения конвейера или внедрить вредоносный код в процесс сборки, определяется степенью детализации PBAC в среде.

## Рекомендации
- [ ] Не используйте общий узел для конвейеров с разными уровнями чувствительности / требующих доступа к разным ресурсам. Общие узлы должны использоваться только для конвейеров с одинаковым уровнем конфиденциальности.
- [ ] Убедитесь, что секреты, используемые в системах CI/CD, распределены таким образом, что каждый конвейер и шаг имеет доступ только к тем секретам, которые ему необходимы.
- [ ] Возвращать узел исполнения к его первозданному состоянию после каждого выполнения конвейера.
- [ ] Убедитесь, что пользователю ОС, выполняющему задание конвейера, предоставлены права доступа к ОС на узле исполнения в соответствии с принципом наименьших привилегий.
- [ ] Задания конвейера CI и CD должны иметь ограниченные права на узле контроллера. При необходимости запускайте задания конвейера на отдельном выделенном узле.
- [ ] Убедитесь, что узел исполнения имеет соответствующее исправление.
- [ ] Убедитесь, что сегментация сети в среде, в которой выполняется задание, настроена таким образом, что узел исполнения получает доступ только к тем ресурсам, которые ему необходимы в сети. По возможности воздержитесь от предоставления узлам сборки неограниченного доступа к Интернету.
- [ ] Если в процессе установки пакета выполняются инсталляционные сценарии, убедитесь, что для них существует отдельный контекст, не имеющий доступа к секретам и другим чувствительным ресурсам, доступным на других этапах сборки.
## Ссылки
1. Codecov, популярный инструмент покрытия кода, используемый в CI, был взломан и использовался для кражи переменных окружения из сборок.
https://about.codecov.io/security-update/

2. NodeJS-приложения Amazon, Zillow, Lyft и Slack стали мишенью для угроз, использующих уязвимость Dependency Confusion. В организациях, ставших жертвами атак Dependency Confusion, на узлах CI выполнялся вредоносный код, что позволяло злоумышленнику перемещаться в среде и злоупотреблять недостаточным PBAC.
https://www.bleepingcomputer.com/news/security/malicious-npm-packages-target-amazon-slack-with-new-dependency-attacks/


3. Уязвимость, обнаруженная в реализации CI Teleport, позволяла злоумышленникам из Интернета выполнить атаку Direct-3PE для запуска привилегированного контейнера и повышения привилегий до уровня root на самом узле, что приводило к утечке секретных данных, выпуску вредоносных артефактов и доступу к конфиденциальным системам.
https://goteleport.com/blog/hack-via-pull-request/